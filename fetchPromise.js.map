{"version":3,"sources":["src/fetchPromise.jsx"],"names":["entries","createBatchEntry","batchObjectToArray","promiseSingleBatch","Promise","resolve","reject","batch","osapi","newBatch","forEach","entry","i","id","request","add","execute","response","error","batchResponseObject","Object","keys","map","content","length","entryArrays","splitArray","Math","ceil","results","concat","pause","promiseBatch","promiseOsapiRequest","promiseOsapiPollingRequest","promiseRestRequest","promiseRestPost","promiseHttpGet","promiseHttpPost","promiseRestDelete","promiseRestPut","delay","setTimeout","array","chunksNumber","newArray","push","undefined","chunkLength","item","chunkNumber","floor","osapiRequestFunc","jive","corev3","filterFunction","targetNumber","maxIterationCount","list","iteration","getNextChunk","executable","then","getNextPage","reason","filter","catch","href","core","get","v","promiseRestGet","post","args","http","delete","put","fetchPromise"],"mappings":";;;;;;;;uEA+MO,iBAA4BA,OAA5B,EAAqCC,gBAArC;AAAA,YAEMC,kBAFN,EAMMC,kBANN;AAAA;AAAA;AAAA;AAAA;AAMMA,0CANN,YAMMA,kBANN,CAMyBH,OANzB,EAMkCC,gBANlC,EAMmD;AAClD,mCAAO,IAAIG,OAAJ,CAAY,UAACC,OAAD,EAAUC,MAAV,EAAqB;;AAEpC,oCAAIC,QAAQC,gBAAMC,QAAN,EAAZ;;AAEAT,wCAAQU,OAAR,CAAgB,UAACC,KAAD,EAAQC,CAAR,EAAc;AAAA,4DACJX,iBAAiBU,KAAjB,EAAwBC,CAAxB,CADI;AAAA,wCACnBC,EADmB,qBACnBA,EADmB;AAAA,wCACfC,OADe,qBACfA,OADe;;AAE1BP,0CAAMQ,GAAN,CAAUF,EAAV,EAAcC,OAAd;AACH,iCAHD;;AAKAP,sCAAMS,OAAN,CAAc,oBAAY;AACtB,wCAAIC,SAASC,KAAb,EAAoB;AAChBZ,+CAAOW,QAAP;AACH,qCAFD,MAEO;AACHZ,gDAAQY,QAAR;AACH;AACJ,iCAND;AAOH,6BAhBM,CAAP;AAiBH,yBAxBE;;AAEMf,0CAFN,YAEMA,kBAFN,CAEyBiB,mBAFzB,EAE6C;AAC5C,mCAAOC,OAAOC,IAAP,CAAYF,mBAAZ,EAAiCG,GAAjC,CAAqC;AAAA,uCAAO,EAACT,MAAD,EAAKU,SAASJ,oBAAoBN,EAApB,CAAd,EAAP;AAAA,6BAArC,CAAP;AACH,yBAJE;;AAAA,8BA0BCb,QAAQwB,MAAR,IAAkB,EA1BnB;AAAA;AAAA;AAAA;;AAAA,sCA2BQtB,kBA3BR;AAAA;AAAA,+BA2BiCC,mBAAmBH,OAAnB,EAA4BC,gBAA5B,CA3BjC;;AAAA;AAAA;AAAA;;AAAA;AA+BOwB,mCA/BP,GA+BqBC,WAAW1B,OAAX,EAAoB2B,KAAKC,IAAL,CAAU5B,QAAQwB,MAAR,GAAiB,EAA3B,CAApB,CA/BrB;AAgCKK,+BAhCL,GAgCe,EAhCf;AAiCKZ,gCAjCL,GAiCgB,KAjChB;AAmCUL,yBAnCV,GAmCc,CAnCd;;AAAA;AAAA,8BAmCiBA,IAAIa,YAAYD,MAnCjC;AAAA;AAAA;AAAA;;AAAA;AAAA,+BAoCsBrB,mBAAmBsB,YAAYb,CAAZ,CAAnB,EAAmCX,gBAAnC,CApCtB;;AAAA;AAoCKgB,gCApCL;;;AAsCKY,kCAAUA,QAAQC,MAAR,CAAe5B,mBAAmBe,QAAnB,CAAf,CAAV;;AAtCL;AAAA,+BAwCWc,MAAM,CAACnB,IAAE,CAAH,IAAQ,CAAR,KAAc,CAAd,GAAkB,KAAlB,GAA0B,IAAhC,CAxCX;;AAAA;AAmCyCA,2BAnCzC;AAAA;AAAA;;AAAA;AAAA,yDA2CQiB,OA3CR;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,K;;oBAAeG,Y;;;;;QA3KNC,mB,GAAAA,mB;QAsBAC,0B,GAAAA,0B;QA6DAC,kB,GAAAA,kB;QAiBAC,e,GAAAA,e;QAeAC,c,GAAAA,c;QAaAC,e,GAAAA,e;QAaAC,iB,GAAAA,iB;QAeAC,c,GAAAA,c;;AA5LhB;;;;AACA;;AACA;;AACA;;AACA;;AACA;;;;;;oMATA;;;;AAWA,SAAST,KAAT,CAAeU,KAAf,EAAqB;AACjB,WAAO,IAAIrC,OAAJ,CAAY,mBAAW;AAC1BsC,mBAAWrC,OAAX,EAAoBoC,KAApB;AACH,KAFM,CAAP;AAGH;;AAED,SAASf,UAAT,CAAoBiB,KAApB,EAA2BC,YAA3B,EAAyC;AACrC,QAAMC,WAAW,EAAjB;;AAEA,SAAK,IAAIjC,IAAI,CAAb,EAAgBA,IAAIgC,YAApB,EAAkChC,GAAlC,EAAsC;AAClCiC,iBAASC,IAAT,CAAc,EAAd;AACH;;AAED,QAAIH,UAAUI,SAAV,IAAuBJ,MAAMnB,MAAjC,EAAwC;AACpC,YAAMwB,cAAcrB,KAAKC,IAAL,CAAUe,MAAMnB,MAAN,GAAeoB,YAAzB,CAApB;;AAEAD,cAAMjC,OAAN,CAAc,UAACuC,IAAD,EAAOrC,CAAP,EAAa;AACvB,gBAAMsC,cAAcvB,KAAKwB,KAAL,CAAWvC,IAAIoC,WAAf,CAApB;AACAH,qBAASK,WAAT,EAAsBJ,IAAtB,CAA2BG,IAA3B;AACH,SAHD;AAIH;;AAED,WAAOJ,QAAP;AACH;;AAEM,SAASZ,mBAAT,CAA6BmB,gBAA7B,EAA8C;AACjD,WAAO,IAAIhD,OAAJ,CAAY,UAACC,OAAD,EAAUC,MAAV,EAAqB;;AAEpC,YAAMQ,UAAU,OAAOsC,gBAAP,KAA4B,UAA5B,GAAyCA,iBAAiB5C,gBAAM6C,IAAN,CAAWC,MAA5B,CAAzC,GAA+EF,gBAA/F;;AAEAtC,gBAAQE,OAAR,CAAgB,oBAAY;AACxB,gBAAIC,SAASC,KAAb,EAAoB;AAChBZ,uBAAOW,QAAP;AACH,aAFD,MAEO;AACHZ,wBAAQY,QAAR;AACH;AACJ,SAND;AAOH,KAXM,CAAP;AAYH;;AAED;;;;;;;AAOO,SAASiB,0BAAT,CAAoCkB,gBAApC,EAAsDG,cAAtD,EAAsEC,YAAtE,EAA2G;AAAA,QAAvBC,iBAAuB,uEAAH,CAAG;;AAC9G,WAAO,IAAIrD,OAAJ,CAAY,UAACC,OAAD,EAAUC,MAAV,EAAqB;;AAEpC,YAAIoD,OAAO,EAAX;AACA,YAAIC,YAAY,CAAhB;;AAEA,iBAASC,YAAT,CAAsBC,UAAtB,EAAkC;;AAE9BF;;AAEA1B,gCAAoB4B,UAApB,EAAgCC,IAAhC,CAAqC,oBAAY;;AAE7C,oBAAMC,cAAc9C,SAAS8C,WAAT,IAAwB,KAA5C;;AAEA;AACA;;;;;;;AAQA,oBAAI,CAAC9C,SAASyC,IAAT,CAAclC,MAAnB,EAA2B;;AAEvBnB,4BAAQ,EAACqD,UAAD,EAAOM,QAAQ,YAAf,EAAR;AAEH,iBAJD,MAIO;;AAEHN,wDAAWA,IAAX,sBAAoBzC,SAASyC,IAAT,CAAcO,MAAd,CAAqBV,cAArB,CAApB;;AAEA,wBAAIG,KAAKlC,MAAL,IAAegC,YAAnB,EAAiC;;AAE7BnD,gCAAQ,EAACqD,UAAD,EAAOK,wBAAP,EAAoBC,iDAA+CL,SAA/C,MAApB,EAAR;AAEH,qBAJD,MAIO;;AAEH,4BAAIF,sBAAsB,CAAtB,IAA2BE,aAAaF,iBAA5C,EAA+D;;AAE3D,gCAAIM,WAAJ,EAAiB;;AAEb;AACAH,6CAAaG,WAAb;AAEH,6BALD,MAKO;AACH1D,wCAAQ,EAACqD,UAAD,EAAOM,QAAQ,kBAAf,EAAR;AACH;AAEJ,yBAXD,MAWO;AACH3D,oCAAQ,EAACqD,UAAD,EAAOK,wBAAP,EAAoBC,QAAQ,iCAA5B,EAAR;AACH;AACJ;AACJ;AAEJ,aA5CD,EA4CGE,KA5CH,CA4CS5D,MA5CT;AA6CH;;AAEDsD,qBAAaR,gBAAb;AACH,KAzDM,CAAP;AA0DH;;AAEM,SAASjB,kBAAT,CAA4BgC,IAA5B,EAAkC;AACrC,WAAO,IAAI/D,OAAJ,CAAY,UAACC,OAAD,EAAUC,MAAV,EAAqB;AACpCE,wBAAM6C,IAAN,CAAWe,IAAX,CAAgBC,GAAhB,CAAoB;AAChBC,eAAE,IADc;AAEhBH;AAFgB,SAApB,EAGGnD,OAHH,CAGW,oBAAY;AACnB,gBAAIC,SAASC,KAAb,EAAoB;AAChBZ,uBAAOW,QAAP;AACH,aAFD,MAEO;AACHZ,wBAAQY,QAAR;AACH;AACJ,SATD;AAUH,KAXM,CAAP;AAYH;;AAEM,IAAMsD,0CAAiBpC,kBAAvB;;AAEA,SAASC,eAAT,CAAyB+B,IAAzB,EAA+B;AAClC,WAAO,IAAI/D,OAAJ,CAAY,UAACC,OAAD,EAAUC,MAAV,EAAqB;AACpCE,wBAAM6C,IAAN,CAAWe,IAAX,CAAgBI,IAAhB,CAAqB;AACjBF,eAAE,IADe;AAEjBH;AAFiB,SAArB,EAGGnD,OAHH,CAGW,oBAAY;AACnB,gBAAIC,SAASC,KAAb,EAAoB;AAChBZ,uBAAOW,QAAP;AACH,aAFD,MAEO;AACHZ,wBAAQY,QAAR;AACH;AACJ,SATD;AAUH,KAXM,CAAP;AAYH;;AAEM,SAASoB,cAAT,GAAgC;AAAA,sCAALoC,IAAK;AAALA,YAAK;AAAA;;AACnC,WAAO,IAAIrE,OAAJ,CAAa,UAACC,OAAD,EAAUC,MAAV,EAAqB;AAAA;;AAErC,uCAAMoE,IAAN,EAAWL,GAAX,oBAAkBI,IAAlB,EAAwBzD,OAAxB,CAAgC,oBAAY;AACxC,gBAAIC,SAASC,KAAb,EAAoB;AAChBZ,uBAAOW,QAAP;AACH,aAFD,MAEO;AACHZ,wBAAQY,QAAR;AACH;AACJ,SAND;AAOH,KATM,CAAP;AAUH;;AAEM,SAASqB,eAAT,GAAiC;AAAA,uCAALmC,IAAK;AAALA,YAAK;AAAA;;AACpC,WAAO,IAAIrE,OAAJ,CAAa,UAACC,OAAD,EAAUC,MAAV,EAAqB;AAAA;;AAErC,wCAAMoE,IAAN,EAAWF,IAAX,qBAAmBC,IAAnB,EAAyBzD,OAAzB,CAAiC,oBAAY;AACzC,gBAAIC,SAASC,KAAb,EAAoB;AAChBZ,uBAAOW,QAAP;AACH,aAFD,MAEO;AACHZ,wBAAQY,QAAR;AACH;AACJ,SAND;AAOH,KATM,CAAP;AAUH;;AAEM,SAASsB,iBAAT,CAA2B4B,IAA3B,EAAiC;AACpC,WAAO,IAAI/D,OAAJ,CAAY,UAACC,OAAD,EAAUC,MAAV,EAAqB;AACpCE,wBAAM6C,IAAN,CAAWe,IAAX,CAAgBO,MAAhB,CAAuB;AACnBL,eAAE,IADiB;AAEnBH;AAFmB,SAAvB,EAGGnD,OAHH,CAGW,oBAAY;AACnB,gBAAIC,SAASC,KAAb,EAAoB;AAChBZ,uBAAOW,QAAP;AACH,aAFD,MAEO;AACHZ,wBAAQY,QAAR;AACH;AACJ,SATD;AAUH,KAXM,CAAP;AAYH;;AAEM,SAASuB,cAAT,CAAwB2B,IAAxB,EAA8B;AACjC,WAAO,IAAI/D,OAAJ,CAAY,UAACC,OAAD,EAAUC,MAAV,EAAqB;AACpCE,wBAAM6C,IAAN,CAAWe,IAAX,CAAgBQ,GAAhB,CAAoB;AAChBN,eAAE,IADc;AAEhBH;AAFgB,SAApB,EAGGnD,OAHH,CAGW,oBAAY;AACnB,gBAAIC,SAASC,KAAb,EAAoB;AAChBZ,uBAAOW,QAAP;AACH,aAFD,MAEO;AACHZ,wBAAQY,QAAR;AACH;AACJ,SATD;AAUH,KAXM,CAAP;AAYH;;AAkDD,IAAM4D,eAAe;AACjBxC,kCADiB;AAEjBC,oCAFiB;AAGjBL,4CAHiB;AAIjBsC,kCAJiB;AAKjBnC,oCALiB;AAMjBI,kCANiB;AAOjBD,wCAPiB;AAQjBJ,0CARiB;AASjBD,0DATiB;AAUjBF;AAViB,CAArB;;kBAae6C,Y","file":"fetchPromise.js","sourcesContent":["/**\n * Created by M. Yegorov on 2016-12-27.\n */\n\nimport osapi from 'jive/osapi'\nimport 'core-js/fn/object/keys'\nimport 'core-js/fn/array/concat'\nimport 'core-js/fn/array/map'\nimport 'core-js/fn/array/for-each'\nimport 'regenerator-runtime/runtime'\n\nfunction pause(delay){\n    return new Promise(resolve => {\n        setTimeout(resolve, delay)\n    })\n}\n\nfunction splitArray(array, chunksNumber) {\n    const newArray = []\n\n    for (let i = 0; i < chunksNumber; i++){\n        newArray.push([])\n    }\n\n    if (array !== undefined && array.length){\n        const chunkLength = Math.ceil(array.length / chunksNumber)\n\n        array.forEach((item, i) => {\n            const chunkNumber = Math.floor(i / chunkLength)\n            newArray[chunkNumber].push(item)\n        })\n    }\n\n    return newArray\n}\n\nexport function promiseOsapiRequest(osapiRequestFunc){\n    return new Promise((resolve, reject) => {\n\n        const request = typeof osapiRequestFunc === 'function' ? osapiRequestFunc(osapi.jive.corev3) : osapiRequestFunc;\n\n        request.execute(response => {\n            if (response.error) {\n                reject(response)\n            } else {\n                resolve(response)\n            }\n        })\n    })\n}\n\n/**\n * todo: нормальная реализация, если надо сделать загрузку один раз, но будет плохо работать если нужна догрузка:\n * возвращает не запрошенное количество, а больший кусок. Нужно придумать вариант, при котором вместо родного\n * getNextPage используется собственный promiseNextPage, в котором содержатся рекурсия на сам promiseOsapiPollingRequest\n * и остаток списка\n */\n\nexport function promiseOsapiPollingRequest(osapiRequestFunc, filterFunction, targetNumber, maxIterationCount = 0) {\n    return new Promise((resolve, reject) => {\n\n        let list = []\n        let iteration = 0\n\n        function getNextChunk(executable) {\n\n            iteration++\n\n            promiseOsapiRequest(executable).then(response => {\n\n                const getNextPage = response.getNextPage || false\n\n                //todo: собственно начало работы над промисом остатка\n                /*const promiseNextPage = function(){\n                 return new Promise((resolve2, reject2) => {\n                 if (list.length >= targetNumber) {\n\n                 }\n                 })\n                 }*/\n\n                if (!response.list.length) {\n\n                    resolve({list, reason: 'no results'})\n\n                } else {\n\n                    list = [...list, ...response.list.filter(filterFunction)]\n\n                    if (list.length >= targetNumber) {\n\n                        resolve({list, getNextPage, reason: `target number reached (on iteration ${iteration})`})\n\n                    } else {\n\n                        if (maxIterationCount === 0 || iteration <= maxIterationCount) {\n\n                            if (getNextPage) {\n\n                                // recursion here\n                                getNextChunk(getNextPage)\n\n                            } else {\n                                resolve({list, reason: 'list end reached'})\n                            }\n\n                        } else {\n                            resolve({list, getNextPage, reason: 'maximum iteration count reached'})\n                        }\n                    }\n                }\n\n            }).catch(reject)\n        }\n\n        getNextChunk(osapiRequestFunc)\n    })\n}\n\nexport function promiseRestRequest(href) {\n    return new Promise((resolve, reject) => {\n        osapi.jive.core.get({\n            v:'v3',\n            href\n        }).execute(response => {\n            if (response.error) {\n                reject(response)\n            } else {\n                resolve(response)\n            }\n        })\n    })\n}\n\nexport const promiseRestGet = promiseRestRequest\n\nexport function promiseRestPost(href) {\n    return new Promise((resolve, reject) => {\n        osapi.jive.core.post({\n            v:'v3',\n            href\n        }).execute(response => {\n            if (response.error) {\n                reject(response)\n            } else {\n                resolve(response)\n            }\n        })\n    })\n}\n\nexport function promiseHttpGet(...args){\n    return new Promise ((resolve, reject) => {\n\n        osapi.http.get(...args).execute(response => {\n            if (response.error) {\n                reject(response)\n            } else {\n                resolve(response)\n            }\n        })\n    })\n}\n\nexport function promiseHttpPost(...args){\n    return new Promise ((resolve, reject) => {\n\n        osapi.http.post(...args).execute(response => {\n            if (response.error) {\n                reject(response)\n            } else {\n                resolve(response)\n            }\n        })\n    })\n}\n\nexport function promiseRestDelete(href) {\n    return new Promise((resolve, reject) => {\n        osapi.jive.core.delete({\n            v:'v3',\n            href\n        }).execute(response => {\n            if (response.error) {\n                reject(response)\n            } else {\n                resolve(response)\n            }\n        })\n    })\n}\n\nexport function promiseRestPut(href) {\n    return new Promise((resolve, reject) => {\n        osapi.jive.core.put({\n            v:'v3',\n            href\n        }).execute(response => {\n            if (response.error) {\n                reject(response)\n            } else {\n                resolve(response)\n            }\n        })\n    })\n}\n\nexport async function promiseBatch(entries, createBatchEntry){\n\n    function batchObjectToArray(batchResponseObject){\n        return Object.keys(batchResponseObject).map(id => ({id, content: batchResponseObject[id]}))\n    }\n\n    function promiseSingleBatch(entries, createBatchEntry){\n        return new Promise((resolve, reject) => {\n\n            let batch = osapi.newBatch()\n\n            entries.forEach((entry, i) => {\n                const {id, request} = createBatchEntry(entry, i)\n                batch.add(id, request)\n            })\n\n            batch.execute(response => {\n                if (response.error) {\n                    reject(response)\n                } else {\n                    resolve(response)\n                }\n            })\n        })\n    }\n\n    if (entries.length <= 30) {\n        return batchObjectToArray(await promiseSingleBatch(entries, createBatchEntry))\n\n    } else {\n\n        const entryArrays = splitArray(entries, Math.ceil(entries.length / 30))\n        let results = []\n        let response = false\n\n        for (let i = 0; i < entryArrays.length; i++){\n            response = await promiseSingleBatch(entryArrays[i], createBatchEntry)\n\n            results = results.concat(batchObjectToArray(response))\n\n            await pause((i+1) % 4 === 0 ? 11000 : 1000)\n        }\n\n        return results\n    }\n}\n\n\nconst fetchPromise = {\n    promiseHttpGet,\n    promiseHttpPost,\n    promiseOsapiRequest,\n    promiseRestGet,\n    promiseRestPost,\n    promiseRestPut,\n    promiseRestDelete,\n    promiseRestRequest,\n    promiseOsapiPollingRequest,\n    promiseBatch\n}\n\nexport default fetchPromise"]}